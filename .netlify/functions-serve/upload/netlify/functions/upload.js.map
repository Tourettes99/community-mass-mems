{
  "version": 3,
  "sources": ["../../../../Documents/community-mass-mems/community-mass-mems/netlify/functions/models/Memory.js", "../../../../Documents/community-mass-mems/community-mass-mems/netlify/functions/upload.js"],
  "sourceRoot": "C:/Users/isman/AppData/Local/Temp/tmp-23272-HQ6f13OSstyI",
  "sourcesContent": ["const mongoose = require('mongoose');\n\nconst memorySchema = new mongoose.Schema({\n  type: {\n    type: String,\n    required: true,\n    enum: ['url', 'text', 'image', 'video', 'audio', 'document']\n  },\n  url: {\n    type: String,\n    required: function() {\n      return this.type === 'url' || this.type === 'image' || this.type === 'video' || this.type === 'audio' || this.type === 'document';\n    }\n  },\n  content: {\n    type: String,\n    required: function() {\n      return this.type === 'text';\n    }\n  },\n  tags: {\n    type: [String],\n    default: []\n  },\n  status: {\n    type: String,\n    required: true,\n    enum: ['pending', 'approved', 'rejected'],\n    default: 'pending'\n  },\n  submittedAt: {\n    type: Date,\n    required: true,\n    default: Date.now\n  },\n  metadata: {\n    title: String,\n    description: String,\n    thumbnailUrl: String,\n    mediaType: String,\n    platform: String,\n    contentUrl: String,\n    fileType: String,\n    domain: String,\n    isSecure: Boolean,\n    createdAt: {\n      type: Date,\n      default: Date.now\n    },\n    updatedAt: {\n      type: Date,\n      default: Date.now\n    },\n    favicon: String,\n    ogTitle: String,\n    ogDescription: String,\n    ogImage: String,\n    ogType: String,\n    twitterTitle: String,\n    twitterDescription: String,\n    twitterImage: String,\n    twitterCard: String\n  },\n  votes: {\n    up: {\n      type: Number,\n      default: 0\n    },\n    down: {\n      type: Number,\n      default: 0\n    }\n  },\n  userVotes: {\n    type: Map,\n    of: String,\n    default: new Map()\n  }\n}, {\n  timestamps: true,\n  toJSON: {\n    virtuals: true,\n    transform: function(doc, ret) {\n      // Format dates as ISO strings\n      if (ret.metadata) {\n        ret.metadata.createdAt = ret.metadata.createdAt ? new Date(ret.metadata.createdAt).toISOString() : null;\n        ret.metadata.updatedAt = ret.metadata.updatedAt ? new Date(ret.metadata.updatedAt).toISOString() : null;\n      }\n      // Transform _id to id\n      ret.id = ret._id.toString();\n      delete ret._id;\n      // Remove MongoDB-specific fields\n      delete ret.__v;\n      // Convert userVotes Map to object for JSON\n      if (ret.userVotes instanceof Map) {\n        ret.userVotes = Object.fromEntries(ret.userVotes);\n      }\n      return ret;\n    }\n  },\n  toObject: {\n    virtuals: true,\n    transform: function(doc, ret) {\n      ret.id = ret._id.toString();\n      if (!(ret.userVotes instanceof Map)) {\n        ret.userVotes = new Map(Object.entries(ret.userVotes || {}));\n      }\n      return ret;\n    }\n  }\n});\n\n// Update metadata timestamps before saving\nmemorySchema.pre('save', function(next) {\n  if (this.isModified()) {\n    const now = new Date();\n    if (!this.metadata) {\n      this.metadata = {};\n    }\n    if (this.isNew) {\n      this.metadata.createdAt = now;\n    }\n    this.metadata.updatedAt = now;\n  }\n  next();\n});\n\nconst Memory = mongoose.model('Memory', memorySchema);\n\nmodule.exports = Memory;\n", "require('dotenv').config();\nconst mongoose = require('mongoose');\nconst Memory = require('./models/Memory');\nconst busboy = require('busboy');\n\nlet conn = null;\n\nconst connectDb = async () => {\n  if (conn == null) {\n    if (!process.env.MONGODB_URI) {\n      throw new Error('MONGODB_URI environment variable is not set');\n    }\n    conn = await mongoose.connect(process.env.MONGODB_URI, {\n      serverSelectionTimeoutMS: 5000\n    });\n  }\n  return conn;\n};\n\nconst processFormData = async (event) => {\n  return new Promise((resolve, reject) => {\n    const bb = busboy({ headers: event.headers });\n    const result = {\n      files: [],\n      fields: {}\n    };\n\n    bb.on('file', (name, file, info) => {\n      const { filename, encoding, mimeType } = info;\n      const chunks = [];\n\n      file.on('data', (data) => chunks.push(data));\n      file.on('end', () => {\n        result.files.push({\n          filename,\n          content: Buffer.concat(chunks),\n          mimeType\n        });\n      });\n    });\n\n    bb.on('field', (name, val) => {\n      result.fields[name] = val;\n    });\n\n    bb.on('finish', () => resolve(result));\n    bb.on('error', (error) => reject(error));\n\n    bb.write(Buffer.from(event.body, 'base64'));\n    bb.end();\n  });\n};\n\nexports.handler = async (event, context) => {\n  context.callbackWaitsForEmptyEventLoop = false;\n\n  // Handle OPTIONS request for CORS\n  if (event.httpMethod === 'OPTIONS') {\n    return {\n      statusCode: 204,\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Headers': 'Content-Type, Accept',\n        'Access-Control-Allow-Methods': 'POST, OPTIONS'\n      },\n      body: ''\n    };\n  }\n\n  if (event.httpMethod !== 'POST') {\n    return {\n      statusCode: 405,\n      headers: {\n        'Allow': 'POST',\n        'Access-Control-Allow-Origin': '*',\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ message: 'Method Not Allowed' })\n    };\n  }\n\n  try {\n    const formData = await processFormData(event);\n    \n    if (!formData.files || formData.files.length === 0) {\n      return {\n        statusCode: 400,\n        headers: {\n          'Content-Type': 'application/json',\n          'Access-Control-Allow-Origin': '*'\n        },\n        body: JSON.stringify({ message: 'No file uploaded' })\n      };\n    }\n\n    const file = formData.files[0];\n    const fileUrl = `data:${file.mimeType};base64,${file.content.toString('base64')}`;\n\n    // Save to MongoDB\n    await connectDb();\n    const fileType = file.mimeType.startsWith('image/') ? \n      (file.mimeType.includes('gif') ? 'gif' : 'image') : \n      (file.mimeType.startsWith('audio/') ? 'audio' : 'url');\n\n    const memory = new Memory({\n      type: fileType,\n      url: fileUrl,\n      metadata: {\n        fileName: file.filename,\n        format: file.mimeType\n      }\n    });\n\n    await memory.save();\n    \n    return {\n      statusCode: 201,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*'\n      },\n      body: JSON.stringify(memory)\n    };\n  } catch (error) {\n    console.error('Error uploading file:', error);\n    return {\n      statusCode: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*'\n      },\n      body: JSON.stringify({ message: 'Error uploading file', error: error.message })\n    };\n  }\n};\n"],
  "mappings": "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",
  "names": ["exports", "module", "mongoose", "Memory"]
}
